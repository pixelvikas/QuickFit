import{S as d,s as c,M as o,a as g,n as h,p as a,b as l,E as f}from"./logger-DD7inj_l.js";import{c as N,r as M,a as w,p as O}from"./run-react-DgJi-wA8.js";import{i as T,c as P}from"./install-service-worker-iFhEZwqq.js";const S="/assets/python-worker-CcTeaR42.js",E=new URL(S,import.meta.url);E.searchParams.set("sessionId",d);let n=null;const W=()=>{const e=new Worker(E.href,{type:"module"});return new Promise(r=>{e.onmessage=t=>{t.data.type===o.READY&&r(e)}})},y=async(e,r)=>{try{n||(n=await W())}catch(t){c.error("failed to create python worker",t)}return new Promise((t,s)=>{if(!n)return s();c.time("python.evaluation"),n.postMessage({code:e}),n.onmessage=u=>{r(u.data),u.data.type===o.RUN_COMPLETE&&(c.timeEnd("python.evaluation"),t(u.data))},n.addEventListener("terminate",()=>t(void 0))})},_=async()=>y("",()=>{}),k=()=>{try{n==null||n.dispatchEvent(new Event("terminate")),n==null||n.terminate()}finally{n=null}},i=e=>({runId:e,id:crypto.randomUUID(),timestamp:Date.now()}),I=async(e,r,t)=>{if(a({type:o.RUN_START,...i(e)}),f&&!await P())return a({...i(e),duration:null,type:o.RUN_COMPLETE}),a({runId:e,type:o.ENVIRONMENT_ERROR,error:{name:"ServiceWorker",message:"Service worker not installed"}});switch(t){case"python":return y(r,s=>{a({...s,...i(e)})});case"javascript":case"typescript":break;case"html":return w({html:r,transformPosition:null,useDocumentWrite:!0,onMessage:s=>{a({...s,...i(e)})}});case"react":for await(const s of M(r,{useDocumentWrite:!0}))a({...s,...i(e)})}},C=e=>{switch(e){case"python":return _();case"react":return O();default:return null}},R=async e=>{try{switch(e.type){case l.STOP_CODE:{const{runId:r}=e;return k(),N(),a({type:o.RUN_COMPLETE,duration:null,wasCancelled:!0,...i(r)})}case l.PREPARE_ENVIRONMENT:{const{language:r}=e;return await C(r)}case l.RUN_CODE:{const{runId:r,code:t,language:s}=e;return await I(r,t,s)}}}catch(r){const t="runId"in e?e.runId:null;r instanceof Error&&a({type:o.ENVIRONMENT_ERROR,runId:t,error:{name:r.name,message:r.message}}),t&&a({type:o.RUN_COMPLETE,duration:null,...i(t)}),c.error("unexpected handleMessage error",r)}},m=[];let p=!1;const v=async e=>{if(m.push(e),!p){for(p=!0;m.length>0;){const r=m.shift();r&&await R(r)}p=!1}};T({routeName:"main",onComplete:()=>{g(e=>{e.type===l.STOP_CODE?R(e):v(e)}),h()},onError:e=>{a({type:o.ENVIRONMENT_ERROR,runId:null,error:{name:"ServiceWorker",message:"Failed to install"}})}});c.log("main.ts complete");
